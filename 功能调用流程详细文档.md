# 好服务平台 - 功能调用流程详细文档

## 1. 文档概述

本文档详细描述了"好服务"平台所有主要功能的调用流程、涉及的关键函数以及数据流向。文档按照功能模块组织，包括用户管理、服务需求管理、服务响应管理和统计数据管理四个核心模块。

## 2. 用户管理功能流程

### 2.1 用户注册

#### 功能描述
用户通过填写用户名、密码和手机号完成注册，系统对密码进行复杂度校验。

#### 调用流程

1. **前端触发**：用户在 `Login.vue` 页面点击"注册"按钮
2. **前端处理**：
   - 调用 `handleRegister()` 函数（`frontend/src/views/Login.vue:336-364`）
   - 进行表单验证
   - 使用 Axios 发送 POST 请求到 `http://127.0.0.1:5000/api/register`
3. **后端处理**：
   - 路由匹配：`app.py:37-80` 中的 `/api/register` 路由
   - 参数验证：检查用户名和密码是否为空
   - 密码复杂度校验：
     - 长度不少于6位
     - 包含至少两个数字
     - 不能全为大写或全为小写
   - 检查用户名是否已存在
   - 创建用户记录并保存到数据库
4. **响应处理**：
   - 后端返回注册结果（成功/失败）
   - 前端显示相应提示信息

#### 涉及的关键函数

| 位置 | 函数名 | 功能描述 |
|------|--------|----------|
| `frontend/src/views/Login.vue:336-364` | `handleRegister()` | 处理注册表单提交 |
| `backend/app.py:37-80` | `register()` | 处理用户注册请求 |
| `models.py` | `User` 模型 | 定义用户数据结构 |

### 2.2 用户登录

#### 功能描述
用户通过用户名和密码登录系统，系统验证身份后返回用户信息。

#### 调用流程

1. **前端触发**：用户在 `Login.vue` 页面点击"登录"按钮
2. **前端处理**：
   - 调用 `handleLogin()` 函数（`frontend/src/views/Login.vue:308-333`）
   - 进行表单验证
   - 使用 Axios 发送 POST 请求到 `http://127.0.0.1:5000/api/login`
3. **后端处理**：
   - 路由匹配：`user_routes.py:10-39` 中的 `/api/login` 路由
   - 参数验证：检查用户名和密码是否为空
   - 数据库查询：根据用户名和密码查询用户
   - 生成响应：返回用户信息（id、用户名、真实姓名、用户类型等）
4. **响应处理**：
   - 前端保存用户信息到 `localStorage`
   - 跳转到首页 `/home`

#### 涉及的关键函数

| 位置 | 函数名 | 功能描述 |
|------|--------|----------|
| `frontend/src/views/Login.vue:308-333` | `handleLogin()` | 处理登录表单提交 |
| `backend/user_routes.py:10-39` | `login()` | 处理用户登录请求 |
| `models.py` | `User.query.filter_by()` | 查询用户记录 |

### 2.3 个人信息管理

#### 功能描述
用户可以查看和修改个人信息，包括手机号和个人简介。

#### 调用流程

1. **前端触发**：用户在 `Profile.vue` 页面点击"保存"按钮
2. **前端处理**：
   - 调用 `saveProfile()` 函数
   - 使用 Axios 发送 PUT 请求到 `http://127.0.0.1:5000/api/user/{user_id}`
3. **后端处理**：
   - 路由匹配：`user_routes.py:64-85` 中的 `/api/user/<int:user_id>` 路由
   - 参数验证：检查用户是否存在
   - 更新用户信息：只允许修改手机号和个人简介
   - 保存到数据库
4. **响应处理**：
   - 前端显示成功/失败提示
   - 更新页面显示

#### 涉及的关键函数

| 位置 | 函数名 | 功能描述 |
|------|--------|----------|
| `frontend/src/views/Profile.vue` | `saveProfile()` | 保存个人信息 |
| `backend/user_routes.py:64-85` | `update_user()` | 更新用户信息 |
| `models.py` | `User` 模型的 `save()` 方法 | 保存用户记录 |

## 3. 服务需求功能流程

### 3.1 发布服务需求

#### 功能描述
用户可以发布新的服务需求，包括标题、服务类型、描述和地域等信息。

#### 调用流程

1. **前端触发**：用户在 `ServiceNeeds.vue` 页面点击"发布新需求"按钮
2. **前端处理**：
   - 调用 `openPublishDialog()` 函数打对话框
   - 填写需求表单·
   - 调用 `submitNeed()` 函数（`frontend/src/views/ServiceNeeds.vue:325-359`）
   - 使用 Axios 发送 POST 请求到 `http://127.0.0.1:5000/api/service-needs`
3. **后端处理**：
   - 路由匹配：`service_need_routes.py:140-180` 中的 `/api/service-needs` 路由（POST）
   - 参数验证：检查必填字段（user_id, subject, service_type）
   - 检查用户是否存在
   - 创建 `ServiceNeed` 记录并保存到数据库
4. **响应处理**：
   - 前端关闭发布对话框
   - 显示成功提示
   - 调用 `loadMyNeeds()` 函数刷新需求列表

#### 涉及的关键函数

| 位置 | 函数名 | 功能描述 |
|------|--------|----------|
| `frontend/src/views/ServiceNeeds.vue:325-359` | `submitNeed()` | 提交服务需求 |
| `frontend/src/views/ServiceNeeds.vue` | `loadMyNeeds()` | 加载用户发布的需求列表 |
| `backend/service_need_routes.py:140-180` | `create_service_need()` | 创建服务需求 |
| `models.py` | `ServiceNeed` 模型 | 定义服务需求数据结构 |

### 3.2 查看服务需求列表

#### 功能描述
用户可以查看自己发布的服务需求列表，包括需求标题、服务类型、状态等信息。

#### 调用流程

1. **前端触发**：用户访问 `ServiceNeeds.vue` 页面
2. **前端处理**：
   - 组件挂载时调用 `onMounted()` 钩子
   - 调用 `loadMyNeeds()` 函数
   - 使用 Axios 发送 GET 请求到 `http://127.0.0.1:5000/api/my-service-needs/{user_id}`
3. **后端处理**：
   - 路由匹配：`service_need_routes.py:103-138` 中的 `/api/my-service-needs/<int:user_id>` 路由
   - 查询数据库：获取指定用户发布的所有需求
   - 分页处理
   - 格式化响应数据
4. **响应处理**：
   - 前端更新 `myNeeds` 变量
   - `v-data-table` 组件自动更新，显示需求列表

#### 涉及的关键函数

| 位置 | 函数名 | 功能描述 |
|------|--------|----------|
| `frontend/src/views/ServiceNeeds.vue` | `loadMyNeeds()` | 加载用户发布的需求列表 |
| `backend/service_need_routes.py:103-138` | `get_my_service_needs()` | 获取用户发布的需求 |
| `models.py` | `ServiceNeed.query.filter_by()` | 查询服务需求记录 |

### 3.3 编辑服务需求

#### 功能描述
用户可以编辑自己发布的服务需求，修改标题、服务类型、描述等信息。

#### 调用流程

1. **前端触发**：用户在需求列表中点击"编辑"按钮
2. **前端处理**：
   - 调用 `editNeed()` 函数，打开编辑对话框
   - 填充现有需求数据
   - 调用 `submitNeed()` 函数（`frontend/src/views/ServiceNeeds.vue:325-359`）
   - 使用 Axios 发送 PUT 请求到 `http://127.0.0.1:5000/api/service-needs/{need_id}`
3. **后端处理**：
   - 路由匹配：`service_need_routes.py:182-218` 中的 `/api/service-needs/<int:need_id>` 路由（PUT）
   - 检查需求是否存在
   - 权限验证：只有发布者可以修改需求
   - 检查需求状态：只有未响应的需求才能修改
   - 更新需求信息并保存到数据库
4. **响应处理**：
   - 前端关闭编辑对话框
   - 显示成功提示
   - 调用 `loadMyNeeds()` 函数刷新需求列表

#### 涉及的关键函数

| 位置 | 函数名 | 功能描述 |
|------|--------|----------|
| `frontend/src/views/ServiceNeeds.vue:325-359` | `submitNeed()` | 提交服务需求（编辑模式） |
| `backend/service_need_routes.py:182-218` | `update_service_need()` | 更新服务需求 |
| `models.py` | `ServiceNeed` 模型的 `save()` 方法 | 保存更新后的服务需求 |

### 3.4 删除服务需求

#### 功能描述
用户可以删除自己发布的服务需求，系统将需求状态标记为"已取消"。

#### 调用流程

1. **前端触发**：用户在需求列表中点击"删除"按钮
2. **前端处理**：
   - 调用 `deleteNeed()` 函数（`frontend/src/views/ServiceNeeds.vue:362-381`）
   - 显示确认对话框
   - 使用 Axios 发送 DELETE 请求到 `http://127.0.0.1:5000/api/service-needs/{need_id}`
3. **后端处理**：
   - 路由匹配：`service_need_routes.py:220-248` 中的 `/api/service-needs/<int:need_id>` 路由（DELETE）
   - 检查需求是否存在
   - 权限验证：只有发布者可以删除需求
   - 检查需求状态：只有未响应的需求才能删除
   - 更新需求状态为 -1（已取消）并保存到数据库
4. **响应处理**：
   - 前端显示成功提示
   - 调用 `loadMyNeeds()` 函数刷新需求列表

#### 涉及的关键函数

| 位置 | 函数名 | 功能描述 |
|------|--------|----------|
| `frontend/src/views/ServiceNeeds.vue:362-381` | `deleteNeed()` | 删除服务需求 |
| `backend/service_need_routes.py:220-248` | `delete_service_need()` | 删除服务需求（标记为已取消） |
| `models.py` | `ServiceNeed` 模型 | 服务需求状态更新 |

## 4. 服务响应功能流程

### 4.1 响应服务需求

#### 功能描述以对他人发布的服务需求进行响应，提供服务帮助。

#### 调用流程

1. **前端触发**：用户在 `ServiceHall.vue` 页面点击"响应"按钮
2. **前端处理**：
   - 调用 `openResponseDialog()` 函数打开响应对话框
   - 填写响应内容
   - 调用 `submitResponse()` 函数
   - 使用 Axios 发送 POST 请求到 `http://127.0.0.1:5000/api/service-responses`
3. **后端处理**：
   - 路由匹配：`service_respon e_routes.py:250-320` 中的 `/api/service-responses` 路由（POST）
   - 参数验证：检查必填字段（need_id, user_id, content）
   - 检查需求是否存在且有效（status=0）
   - 检查用户是否存在
   - 权限验证：不允许对自己的需求进行响应
   - 检查是否已经响应过
   - 创建 `ServiceResponse` 记录并保存到数据库
4. **响应处理**：
   - 前端关闭响应对话框
   - 显示成功提示
   - 刷新服务大厅列表

#### 涉及的关键函数

| 位置 | 函数名 | 功能描述 |
|------|--------|----------|
| `frontend/src/views/ServiceHall.vue` | `submitResponse()` | 提交服务响应 |
| `backend/service_response_routes.py:250-320` | `create_service_response()` | 创建服务响应 |
| `models.py` | `ServiceResponse` 模型 | 定义服务响应数据结构 |

### 4.2 查看需求响应列表

#### 功能描述
需求发布者可以查看针对自己需求的所有响应，包括响应者信息、响应内容和状态。

#### 调用流程

1. **前端触发**：用户在 `NeedsManagement.vue` 页面点击"查看响应"按钮
2. **前端处理**：
   - 调用 `loadResponses()` 函数（`frontend/src/views/NeedsManagement.vue:250`）
   - 使用 Axios 发送 GET 请求到 `http://127.0.0.1:5000/api/service-needs/{need_id}/responses`
3. **后端处理**：
   - 路由匹配：`service_response_routes.py:191-247` 中的 `/api/service-needs/<int:need_id>/responses` 路由
   - 查询数据库：获取指定需求的所有响应
   - 分页处理
   - 格式化响应数据，包含响应者信息
4. **响应处理**：
   - 前端显示响应列表
   - 用户可以对每个响应进行接受或拒绝操作

#### 涉及的关键函数

| 位置 | 函数名 | 功能描述 |
|------|--------|----------|
| `frontend/src/views/NeedsManagement.vue:250` | `loadResponses()` | 加载需求的响应列表 |
| `backend/service_response_routes.py:191-247` | `get_need_responses()` | 获取需求的响应列表 |
| `models.py` | `ServiceResponse` 模型 | 服务响应数据查询 |

### 4.3 接受/拒绝响应

#### 功能描述
需求发布者可以接受或拒绝针对自己需求的响应，每个需求只能接受一个响应。

#### 调用流程

1. **前端触发**：用户在 `NeedsManagement.vue` 页面点击"接受"或"拒绝"按钮
2. **前端处理**：
   - 调用 `acceptResponse()` 或 `rejectResponse()` 函数
   - 使用 Axios 发送 PUT 请求到 `http://127.0.0.1:5000/api/service-responses/{response_id}`
   - 请求体包含新的状态值（1=接受，2=拒绝）
3. **后端处理**：
   - 路由匹配：`service_response_routes.py:323-408` 中的 `/api/service-responses/<int:response_id>` 路由（PUT）
   - 检查响应是否存在
   - 权限验证：只有需求发布者可以接受/拒绝响应
   - 状态更新处理：
     - 接受响应（status=1）：
       - 检查是否已有其他被接受的响应
       - 创建 `ResponseSuccess` 记录
       - 更新响应状态
     - 拒绝响应（status=2）：直接更新响应状态
   - 保存到数据库
4. **响应处理**：
   - 前端显示成功提示
   - 刷新响应列表
   - 更新响应状态显示

#### 涉及的关键函数

| 位置 | 函数名 | 功能描述 |
|------|--------|----------|
| `frontend/src/views/NeedsManagement.vue` | `acceptResponse()` | 接受服务响应 |
| `frontend/src/views/NeedsManagement.vue` | `rejectResponse()` | 拒绝服务响应 |
| `backend/service_response_routes.py:323-408` | `update_service_response()` | 更新服务响应状态 |
| `models.py` | `ResponseSuccess` 模型 | 定义成功配对记录数据结构 |

## 5. 统计数据功能流程

### 5.1 获取统计概览

#### 功能描述
管理员可以查看系统的统计概览，包括总用户数、活跃需求数、总响应数和成功配对数。

#### 调用流程

1. **前端触发**：用户访问 `AdminStats.vue` 页面
2. **前端处理**：
   - 组件挂载时调用 `onMounted()` 钩子
   - 调用 `loadOverviewStats()` 函数
   - 使用 Axios 发送 GET 请求到 `http://127.0.0.1:5000/api/admin/stats/overview`
3. **后端处理**：
   - 路由匹配：`admin_routes.py` 中的 `/api/admin/stats/overview` 路由
   - 查询数据库：
     - 总用户数：查询 `User` 表
     - 活跃需求数：查询 `ServiceNeed` 表（status=0）
     - 总响应数：查询 `ServiceResponse` 表
     - 成功配对数：查询 `ResponseSuccess` 表
   - 计算统计数据并返回
4. **响应处理**：
   - 前端更新统计概览卡片显示

#### 涉及的关键函数

| 位置 | 函数名 | 功能描述 |
|------|--------|----------|
| `frontend/src/views/AdminStats.vue` | `loadOverviewStats()` | 加载统计概览数据 |
| `backend/admin_routes.py` | `get_overview_stats()` | 获取统计概览数据 |
| `models.py` | 多个模型的查询操作 | 统计数据计算 |

### 5.2 按服务类型统计

#### 功能描述
管理员可以查看按服务类型统计的需求和响应数据。

#### 调用流程

1. **前端触发**：用户访问 `AdminStats.vue` 页面
2. **前端处理**：
   - 调用 `loadServiceTypeStats()` 函数
   - 使用 Axios 发送 GET 请求到 `http://127.0.0.1:5000/api/admin/stats/by-service-type`
3. **后端处理**：
   - 路由匹配：`admin_routes.py` 中的 `/api/admin/stats/by-service-type` 路由
   - 查询数据库：
     - 按服务类型分组查询 `ServiceNeed` 表
     - 按服务类型分组查询 `ResponseSuccess` 表
   - 合并数据并返回
4. **响应处理**：
   - 前端更新图表数据
   - 使用 Chart.js 绘制服务类型分布图表

#### 涉及的关键函数

| 位置 | 函数名 | 功能描述 |
|------|--------|----------|
| `frontend/src/views/AdminStats.vue` | `loadServiceTypeStats()` | 加载服务类型统计数据 |
| `backend/admin_routes.py` | `get_stats_by_service_type()` | 获取按服务类型统计的数据 |
| `frontend/src/views/AdminStats.vue` | Chart.js 相关函数 | 绘制服务类型分布图表 |

### 5.3 按地域统计

#### 功能描述
管理员可以查看按地域统计的需求和响应数据。

#### 调用流程

1. **前端触发**：用户访问 `AdminStats.vue` 页面
2. **前端处理**：
   - 调用 `loadRegionStats()` 函数
   - 使用 Axios 发送 GET 请求到 `http://127.0.0.1:5000/api/admin/stats/by-region`
3. **后端处理**：
   - 路由匹配：`admin_routes.py` 中的 `/api/admin/stats/by-region` 路由
   - 查询数据库：
     - 按地域分组查询 `ServiceNeed` 表
     - 按地域分组查询 `ResponseSuccess` 表
   - 合并数据并返回
4. **响应处理**：
   - 前端更新图表数据
   - 使用 Chart.js 绘制地域分布图表

#### 涉及的关键函数

| 位置 | 函数名 | 功能描述 |
|------|--------|----------|
| `frontend/src/views/AdminStats.vue` | `loadRegionStats()` | 加载地域统计数据 |
| `backend/admin_routes.py` | `get_stats_by_region()` | 获取按地域统计的数据 |
| `frontend/src/views/AdminStats.vue` | Chart.js 相关函数 | 绘制地域分布图表 |

### 5.4 获取月度统计数据

#### 功能描述
管理员可以查看按月度统计的服务需求和响应数据，支持按时间范围、地域和服务类型筛选。

#### 调用流程

1. **前端触发**：用户访问 `AdminStats.vue` 页面，或修改筛选条件
2. **前端处理**：
   - 调用 `loadMonthlyStats()` 函数（`frontend/src/views/AdminStats.vue:637-660`）
   - 使用 Axios 发送 GET 请求到 `http://127.0.0.1:5000/api/admin/stats/monthly-summary`，携带筛选参数
3. **后端处理**：
   - 路由匹配：`admin_routes.py` 中的 `/api/admin/stats/monthly-summary` 路由
   - 查询数据库：
     - 按月份分组查询 `ServiceNeed` 表
     - 按月份分组查询 `ResponseSuccess` 表
   - 应用筛选条件（时间范围、地域、服务类型）
   - 计算月度统计数据并返回
4. **响应处理**：
   - 前端更新表格数据
   - 更新 Chart.js 图表显示

#### 涉及的关键函数

| 位置 | 函数名 | 功能描述 |
|------|--------|----------|
| `frontend/src/views/AdminStats.vue:637-660` | `loadMonthlyStats()` | 加载月度统计数据 |
| `backend/admin_routes.py` | `get_monthly_summary_stats()` | 获取月度统计数据 |
| `frontend/src/views/AdminStats.vue` | Chart.js 相关函数 | 绘制月度统计图表 |
| `models.py` | `MonthlySummary` 模型 | 月度统计数据结构 |

## 6. 数据流向总览

### 6.1 前端数据流向

```
用户交互 → Vue 组件 → Axios 请求 → 后端 API → Axios 响应 → Vue 组件更新 → UI 显示
```

### 6.2 后端数据流向

```
HTTP 请求 → Flask 路由 → 业务逻辑处理 → 数据库查询/更新 → 响应生成 → HTTP 响应
```

### 6.3 数据库交互

```
Flask 应用 → SQLAlchemy ORM → SQL 查询 → MySQL 数据库 → 查询结果 → SQLAlchemy ORM → Python 对象 → Flask 应用
```

## 7. 核心业务规则

1. **密码复杂度规则**：密码长度不少于6位，包含至少两个数字，不能全为大写或全为小写
2. **响应规则**：
   - 不允许对自己的需求进行响应
   - 每个需求只能接受一个响应
   - 接受响应后创建成功配对记录
3. **需求状态规则**：
   - 0：已发布（活跃）
   - -1：已取消
4. **响应状态规则**：
   - 0：待处理
   - 1：已接受
   - 2：已拒绝
   - 3：已取消

## 8. 技术栈总结

| 分类 | 技术 | 版本 | 用途 |
|------|------|------|------|
| 前端框架 | Vue | 3.x | 构建响应式用户界面 |
| UI 组件库 | Vuetify | 3.x | 提供美观的 UI 组件 |
| 路由管理 | Vue Router | 4.x | 前端路由管理 |
| HTTP 客户端 | Axios | ^1.13.2 | 发送 HTTP 请求 |
| 图表库 | Chart.js | - | 数据可视化 |
| 后端框架 | Flask | - | 构建 RESTful API |
| ORM 库 | SQLAlchemy | - | 数据库操作 |
| 数据库 | MySQL | - | 数据存储 |

## 9. 文档更新记录

| 日期 | 版本 | 更新内容 | 作者 |
|------|------|----------|------|
| 2026-01-06 | v1.0 | 初始版本，包含所有主要功能的调用流程 |  |

---

本文档详细描述了"好服务"平台的功能调用流程，涵盖了从用户注册到统计数据展示的所有核心功能。通过阅读本文档，可以全面了解系统的工作原理和数据流向，有助于系统维护和功能扩展。
